#distribute traffic accross servers and to give all users the ip(DNS) of the load balancer
#requires default availability zones 
#created through aws ec2 create-default-subnet --availability-zone us-east-1a --region us-east-1
resource "aws_elb" "this_elb" {

    name = var.elb_name
    availability_zones = data.aws_availability_zones.all.names 
    security_groups = [aws_security_group.this_elb.id]
    #listener/load balancer
    #requires security group to be set to allow comms
    listener {
      lb_port = var.lb_port
      lb_protocol = var.lb_proto
      instance_port = var.server_port
      instance_protocol = var.instance_proto
    }
    #requires security group egress setting for elb to ec2s
    health_check {
      healthy_threshold      = 2
      unhealthy_threshold    = 2
      timeout                = 3
      interval               = 30
      target                 = "HTTP:${var.server_port}/"
    }
  #HTTPS
  #listener {
  #  instance_port      = 8000
  #  instance_protocol  = "http"
  #  lb_port            = 443
  #  lb_protocol        = "https"
  #  ssl_certificate_id = "arn:aws:iam::123456789012:server-certificate/certName"
  #}

  tags = {
    Name = var.elb_name
  }

}